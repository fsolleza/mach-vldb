<html>
  <head>
    <style>
      a.canvasjs-chart-credit {
        visibility: hidden;
      }

      body {
        font-family: Arial !important;
        font-size: small;
      }

      .plotTitleOuter {
         height: 150px;
         width: 100px;
      }

      .plotTitleContainer {
         height: 150px;
         width: 100px;
         display: table-cell;
         vertical-align: middle;
      }

      .plotTitle {
         display: inner-block;
         float:right;
         writing-mode: sideways-lr;
         text-orientation: mixed;
         font-weight: bold;
         padding-right: 10px;
         font-size: medium;
      }

      .mainDiv {
        margin: auto;
        display: grid;
        grid-template-rows: auto auto 200px;
        row-gap: 10px;
      }

      .columnDiv {
        margin: 0;
      }

      .bodyRow {
        display: grid;
        grid-template-columns: 800px 800px;
        column-gap: 10px;
      }

      span.boldSpan {
        font-weight: bold;
      }

      .chartsRow {
        display: grid;
        grid-template-columns: auto auto;
        column-gap: 5px;
      }

      .chartFrame {
        height: 900px;
        width: 850px;
        border:none;
      }

      .controlRow {
        height: auto;
      }

      .controlRowContainer {
        height: 50px;
        float: left;
      }

      .controlRowContainerItem {
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #queryRateDiv {
        width: auto;
        height: 50px;
      }

    </style>

    <title> </title>

  </head>

  <body>
    <div class="mainDiv">

      <div class="controlRow">
        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
          <span style="font-size: large; font-weight: bold">
            <b>RocksDB Request Rate (Per Second): </b>
          </span>
          </div>
        </div>
        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <input
              type="range"
              min="1000"
              max="1000000"
              value="10000"
              id="qpsToggle"
              oninput="qpsValue.value = qpsToggle.value - qpsToggle.value % 10000">
            </input>
          </div>
        </div>

        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large; font-weight: bold">
            <output id="qpsValue">10000</output>
            </span>
          </div>
        </div>

        <div class="controlRowContainer">
          <div style="width:10px"></div>
        </div>

        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large; font-weight: bold">
            Measured Request Rate:&nbsp <span class="boldSpan" id="kvOpsPerSec">0</span>
            </span>
          </div>
        </div>


      </div> <!-- controlRow -->

      <div class="controlRow">
        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large">
              <input
                type="checkbox"
                id="pauseBox"
                name="pauseBox"
                checked>
              <label for="pauseBox">Pause graphs  |</label>
            </span>
          </div>
        </div>

        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large">
              <input
                type="checkbox"
                id="enableKvOps"
                name="enableKvOps">
              <label for="enableKvOps">Enable RocksDB Request Latency  |</label>
            </span>
          </div>
        </div>

        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large">
              <input
                type="checkbox"
                id="enableSystemCalls"
                name="enableSystemCalls">
              <label for="enableSystemCalls">Enable Read System Calls  |</label>
            </span>
          </div>
        </div>

        <div class="controlRowContainer">
          <div class="controlRowContainerItem">
            <span style="font-size: large">
              <input
                type="checkbox"
                id="enableScheduler"
                name="enableScheduler">
              <label for="enableScheduler">Enable Scheduler Events  |</label><br>
            </span>
          </div>
        </div>
      </div> <!-- dataToggles -->

      <div class="chartsRow">

        <div>
          <iframe src="mach" class="chartFrame" id="machIframe">
          </iframe>
        </div>

        <div>
          <iframe src="influx" class="chartFrame" id="influxIframe">
          </iframe>
        </div>

      </div> <!-- chartsRow -->

    </div> <!-- mainDiv -->

  <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
  <script>
    /*
     * Parameters
     */
    var TILE = 0.99
    var NOW = micros_now();

    /*
     * Set queries per second in the RDB application
     */
    var LAST_QPS = 0;
    function updateQps() {
      var qps = Number(document.getElementById("qpsToggle").value);
      if (qps == LAST_QPS) {
        return;
      }
      LAST_QPS = qps;

      var req = {
        "SetQps": {
          "rate": qps
        }
      }

      var update_fn = function(data) {
        //console.log("Successfully set qps", data);
      };

      send_request(req, update_fn);
    }

    /*
     * Update measured query rate
     */
    function updateKvOpsPerSec() {
      var elem = document.getElementById("kvOpsPerSec");

      var req = "OpsPerSec";

      var update_fn = function(data) {
        elem.innerText = data.OpsPerSec;
      };

      send_request(req, update_fn);
    }


    var PAGE_STATE = {
        pause: true,
        syscalls: false,
        scheduler: false,
        kvops: false,
        mach_kv_max: 0,
        mach_syscall_max: 0,
        influx_kv_max: 0,
        influx_syscall_max: 0,
        kv_max: 0,
        syscall_max: 0,
    };

    function sendPageState() {
      var pause = document.getElementById("pauseBox").checked;
      var enableSyscalls = document.getElementById("enableSystemCalls").checked;
      var enableScheduler = document.getElementById("enableScheduler").checked;
      var enableKvOps = document.getElementById("enableKvOps").checked;

      PAGE_STATE.pause = pause;
      PAGE_STATE.syscalls = enableSyscalls;
      PAGE_STATE.scheduler = enableScheduler;
      PAGE_STATE.kvops = enableKvOps;

      PAGE_STATE.kv_max = PAGE_STATE.mach_kv_max;
      if (PAGE_STATE.kv_max < PAGE_STATE.influx_kv_max) {
        PAGE_STATE.kv_max = PAGE_STATE.influx_kv_max;
      }

      PAGE_STATE.syscall_max = PAGE_STATE.mach_syscall_max;
      if (PAGE_STATE.syscall_max < PAGE_STATE.influx_syscall_max) {
        PAGE_STATE.syscall_max = PAGE_STATE.influx_syscall_max;
      }


      const machIframe = document.getElementById('machIframe');
      machIframe.contentWindow.postMessage(PAGE_STATE, '*');

      const influxIframe = document.getElementById('influxIframe');
      influxIframe.contentWindow.postMessage(PAGE_STATE, '*');
    }

    window.onmessage = function(e) {
      if (e.data.mach_kv_max > 0) {
        PAGE_STATE.mach_kv_max = e.data.mach_kv_max;
      }

      if (e.data.influx_kv_max > 0) {
        PAGE_STATE.influx_kv_max = e.data.influx_kv_max;
      }

      if (e.data.influx_syscall_max > 0) {
        PAGE_STATE.influx_syscall_max = e.data.influx_syscall_max;
      }

      if (e.data.mach_syscall_max > 0) {
        PAGE_STATE.mach_syscall_max = e.data.mach_syscall_max;
      }

      console.log("page state", PAGE_STATE);
    };

    ///*
    // * Send message to iframes
    // */
    //function sendIframeMessage() {
    //  var enableSyscalls = document.getElementById("enableSystemCalls").checked;
    //  var enableScheduler = document.getElementById("enableScheduler").checked;
    //  var enableKvOps = document.getElementById("enableKvOps").checked;

    //  var enabled = {
    //    syscalls: enableSyscalls,
    //    scheduler: enableScheduler,
    //    kvops: enableKvOps,
    //  };

    //  const machIframe = document.getElementById('machIframe');
    //  machIframe.contentWindow.postMessage(enabled, '*');

    //  const influxIframe = document.getElementById('influxIframe');
    //  influxIframe.contentWindow.postMessage(enabled, '*');
    //}

    /*
     * Helper function to send request and call func when request completes
     */
    function send_request(req, func) {
      var request = JSON.stringify(req);
      var request = new Request("http://localhost:3000/dataRequest", {
        method: 'POST',
        body: request,
        headers: new Headers({
            'Content-Type': 'application/json'
        })
      });
      fetch(request)
        .then(data => data.json())
        .then(data => func(data));
    }

    /*
     * Helper functions to get microseconds now
     */
    function micros_now() {
      var nowSecs = Math.floor(Date.now() / 1000);
      return nowSecs * 1000000;
    }

    /*
     * Helper to convert seconds since epoch to a Date object
     */
    function secsToDt(s) {
      var t = new Date(1970, 0, 1); // Epoch
      t.setSeconds(s);
      return t;
    }

    /*
     * Update data and charts every second
     */
    function updateData() {
      updateQps();
      updateKvOpsPerSec();
      sendPageState();
    }
    setInterval(updateData, 1000);

  </script>
  </body>
</html>
