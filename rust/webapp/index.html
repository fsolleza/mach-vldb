<!DOCTYPE HTML>
<html>
<head>

</head>
<body>

<input class="sourceBox" type="checkbox" value="SourceA">SourceA</input>
<input class="sourceBox" type="checkbox" value="SourceB">SourceB</input>
<br>
<input id="pauseBox" type="checkbox" value="SourceA">Pause</input>
<br>

<div id="scatterPlot" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>

<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script>

var scatterPlot = new CanvasJS.Chart("scatterPlot", {
	title:{
		text: "Server Performance"
	},
	axisX: {
		title:"Time",
        interval: 1,
        intervalType: "minute",
        labelWrap: false,
        labelTextAlign: "right",
        labelAngle: -45,
	},
	axisY:{
		title: "Response Time (in ms)",
		includeZero: true
	},
	data: [{
		type: "scatter",
		name: "SourceA",
		showInLegend: true,
        xValueType: "dateTime",
		xValueFormatString: "hh:mm TT",
		dataPoints: []
	},
	{
		type: "scatter",
		name: "SourceB",
		showInLegend: true,
        xValueType: "dateTime",
		xValueFormatString: "hh:mm TT",
		dataPoints: []
	}]
});

function sourcesList() {
    var sources = [];
    var inputFields = document.getElementsByClassName('sourceBox');
    let inputFieldsNumber = inputFields.length;

    for(let i=0; i<inputFieldsNumber; i++) {
        if (
           inputFields[i].type == 'checkbox' &&
           inputFields[i].checked == true
        ) {
            sources.push(inputFields[i].value);
        }
    }
    return JSON.stringify(
        {
            sources: sources,
        }
    );
}

function plotIsPaused() {
    var pauseField = document.getElementById('pauseBox');
    return pauseField.checked;
}

function shiftChart() {
    var max = Date.now();
    var min = max - (1000 * 300);
    console.log(Date.now());
    scatterPlot.axisX[0].set("maximum", max);
    scatterPlot.axisX[0].set("minimum", min);
    scatterPlot.options.data[0].dataPoints = [{ x: max, y: 0 }];
}

/*
    {
        data: [
            { source: "SourceA", data: [ { x: int, y: int } ] },
        ]
    }
*/

function updateChartData(newData) {
    console.log("New data: ", newData);
    var data = newData.data;
    for (i = 0; i < data.length; i++) {
        var source = data[i].source;
        var sourceData = data[i].data;
        var plotData = scatterPlot.options.data
        for (j = 0; j < plotData.length; j++) {
            console.log("Updating ", plotData[j].name, source);
            if (plotData[j].name === source) {
                plotData[j].dataPoints = sourceData;
                break;
            }
        }
    }
    scatterPlot.render();
}

function updateChart() {
    var sources = sourcesList(document.getElementById("sourcesForm"));
    console.log(sources);
    var request = new Request("http://localhost:3000/scatterPlot", {
        method: 'POST',
        body: sources,
        headers: new Headers({
            'Content-Type': 'application/json'
        })
    });
    fetch(request)
        .then(res => res.json())
        .then(res => { updateChartData(res) });
}


scatterPlot.render();
setInterval(function() {
    var paused = plotIsPaused();
    console.log(paused);
    if (!paused) {
        updateChart()
    }
}, 1000);
</script>

</body>
</html>

