<!DOCTYPE HTML>
<html>
<head>
<style>
a.canvasjs-chart-credit {
    visibility: hidden;
}

body {
   font-family: Arial !important;
   font-size: small;
}
</style>
</head>

<body>

<div style="margin: auto; display: grid; grid-template-columns: 350px 850px; column-gap: 100px,">
    <div style="margin: 0; display: grid; grid-template-rows: 280px 50px 200px;">
		<div>

			<p><b>Target Field</b></p>

			<p>
				<input type="radio" id="ops" name="targetField" value="ops">
        		<label for="ops">Ops</label>
				</br>

				<input type="radio" id="latency" name="targetField" value="latency">
        		<label for="latency">Duration</label>
				</br>

				<input type="radio" id="latency" name="targetField" value="sched">
        		<label for="latency">Scheduler Events</label>
			</p>

			<p><b>Available Aggregation Methods</b> <br></p>

			<p>
				<div name="aggDiv" id="aggCount" style="display: none">
					<input type="radio" id="countRadio" name="aggRadio" value="count">
        			<label for="countRadio">Count</label>
					</br>
				</div>

				<div name="aggDiv" id="aggAvg" style="display: none">
					<input type="radio" id="avgRadio" name="aggRadio" value="avg">
        			<label for="avgRadio">Average</label>
					</br>
				</div>

				<div name="aggDiv" id="aggMax" style="display: none">
					<input type="radio" id="maxRadio" name="aggRadio" value="max">
        			<label for="maxRadio">Max</label>
					</br>
				</div>
			</p>

			<p><b>Available Group By Fields</b> <br></p>

			<p>
				<div name="groupByDiv" id="groupByCpu" style="display: none">
					<input name="groupByBox" type="checkbox" id="cpuBox">CPU <br>
				</div>

				<div name="groupByDiv" id="groupByTid" style="display: none">
					<input name="groupByBox" type="checkbox" id="tidBox">TID <br>
				</div>

				<div name="groupByDiv" id="groupByComm" style="display: none">
					<input name="groupByBox" type="checkbox" id="commBox">Comm <br>
				</div>

			</p>

		</div>

		<div>
			<input type="button" onclick="updateCharts()" value="Update Chart" id="doAppEvents">
        	<input type="checkbox" id="pauseRequests"> Check to pause <br>
		</div>

        <div id="plotD"> </div>
    </div>
    <div>
        <div style="width: auto; display: grid; grid-template-rows: 150px 150px 150px; row-gap: 5px">
            <div id="summaryPlot"></div>
            <div id="machPlot"></div>
            <div id="influxPlot"></div>
        </div>
    </div>
</div>

<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script>

var START_SECONDS = Math.floor(Date.now() / 1000);
var REQUESTS = []

function isPaused() {
    var pauseField = document.getElementById('pauseRequests');
    return pauseField.checked;
}

var TARGET_FIELDS = document.getElementsByName("targetField");
TARGET_FIELDS.forEach(choice => {
	choice.onclick = () => {
		if (choice.checked) {
			setAggMethod(choice.value);
			setGroupBy(choice.value);
		}
	}
});

function setAggMethod(value) {
	document.getElementsByName("aggDiv").forEach(f => {
		f.style.display = "none";
	});

	document.getElementsByName("aggRadio").forEach(f => {
		f.checked = false;
	});

	if (value == "ops") {
		document.getElementById("aggCount").style.display = "block";
	}
	else if (value == "latency") {
		document.getElementById("aggAvg").style.display = "block";
		document.getElementById("aggMax").style.display = "block";
	}
	else if (value == "sched") {
		document.getElementById("aggCount").style.display = "block";
	}
}

function setGroupBy(value) {

	document.getElementsByName("groupByDiv").forEach(f => {
		f.style.display = "none";
	});

	document.getElementsByName("groupByBox").forEach(f => {
		f.checked = false;
	});

	if (value == "ops") {
		document.getElementById("groupByCpu").style.display = "block";
		document.getElementById("groupByTid").style.display = "block";
	}
	else if (value == "latency") {
		document.getElementById("groupByCpu").style.display = "block";
		document.getElementById("groupByTid").style.display = "block";
	}
	else if (value == "sched") {
		document.getElementById("groupByCpu").style.display = "block";
		document.getElementById("groupByComm").style.display = "block";
	}
}


setInterval(
	function() {
		var paused = isPaused();
    	if (paused) {
			console.log("paused");
		} else {
			console.log("not paused");
			updateCharts();
		}
	},
	1000
);

function updateCharts() {
	summaryPlotUpdate();
	summaryPlot.render();
}

var summaryPlotData = [{
	type: "line",
	dataPoints: []
}]

var summaryPlot = new CanvasJS.Chart("summaryPlot", {
    title: {
        text: "Summary",
        fontFamily: "arial",
        fontSize: 16,
        fontWeight: "bold",
        backgroundColor: "#ffffff",
        verticalAlign: "center",
        horizontalAlign: "left"
    },

	axisX: [{
        interval: 10,
        intervalType: "second",
        labelWrap: false,
        labelTextAlign: "right",
        labelAngle: -20,
        titleFontSize: 14,
        labelFontSize: 14,
        lineColor: "#ddd",
	}],

	axisY:{
        title: "QPS",
		includeZero: true,
        titleFontSize: 14,
        labelFontSize: 14,
        tickPlacement: "inside", //Change it to "outside"
        labelPlacement: "inside", //Change it to "outside"
        gridColor: "#ddd"
	},

    width: 800,
	data: summaryPlotData
})

function summaryPlotUpdate() {

	var nowSecs = Math.floor(Date.now() / 1000);
	var max = (nowSecs - 2) * 1000000;   // in micros
	var min = max - 1000000;             // in micros

	var req = {
		"Data": {
			"storage": "Mem",
			"field": "DurationMicros",
			"min_ts_micros": min,
			"max_ts_micros": max,
			"aggregation": "Avg",
			"grouping": [],
		}
	}

    var request = JSON.stringify(req);
    var request = new Request("http://localhost:3000/dataRequest", {
        method: 'POST',
        body: request,
        headers: new Headers({
            'Content-Type': 'application/json'
        })
    });
    fetch(request)
		.then(data => data.json())
		.then(data => {
			timestamp_secs = Math.floor(data.Data[0].data[0][0] / 1000000);
			value = data.Data[0].data[0][1];
			updateArray(summaryPlotData[0].dataPoints, timestamp_secs, value);
		});
};

function secsToDt(s) {
	var t = new Date(1970, 0, 1); // Epoch
    t.setSeconds(s);
    return t;
}

function updateArray(array, timestamp_secs, value) {
	if (array.length == 0) {
		for (var i = 60; i > 0; i--) {
			array.push({ x: secsToDt(timestamp_secs - i), y: NaN});
		}
	}

	for (var i = 0; i < array.length - 1; i++) {
		array[i] = array[i+1];
	}
	array[array.length - 1] = { x: secsToDt(timestamp_secs), y: value };
}

var machPlotData = [{
	type: "line",
	dataPoints: []
}]

var machPlot = new CanvasJS.Chart("machPlot", {
    title: {
        text: "Mach",
        fontFamily: "arial",
        fontSize: 16,
        fontWeight: "bold",
        backgroundColor: "#ffffff",
        verticalAlign: "center",
        horizontalAlign: "left"
    },

	axisX: [{
        interval: 10,
        intervalType: "second",
        labelWrap: false,
        labelTextAlign: "right",
        labelAngle: -20,
        titleFontSize: 14,
        labelFontSize: 14,
        lineColor: "#ddd",
	}],

	axisY:{
        title: "QPS",
		includeZero: true,
        titleFontSize: 14,
        labelFontSize: 14,
        tickPlacement: "inside", //Change it to "outside"
        labelPlacement: "inside", //Change it to "outside"
        gridColor: "#ddd"
	},

    width: 800,
	data: machPlotData
})

function machPlotUpdate() {
	count = 60;
	xVal = 0;
	yVal = 100;

	for (var j = 0; j < count; j++) {
		yVal = yVal +  Math.round(5 + Math.random() *(-5-5));
		machPlotData[0].dataPoints.push({
			x: xVal,
			y: yVal
		});
		xVal++;
	}

	machPlot.render();
};

var influxPlotData = [{
	type: "line",
	dataPoints: []
}]

var influxPlot = new CanvasJS.Chart("influxPlot", {
    title: {
        text: "Influx",
        fontFamily: "arial",
        fontSize: 16,
        fontWeight: "bold",
        backgroundColor: "#ffffff",
        verticalAlign: "center",
        horizontalAlign: "left"
    },

	axisX: [{
        interval: 10,
        intervalType: "second",
        labelWrap: false,
        labelTextAlign: "right",
        labelAngle: -20,
        titleFontSize: 14,
        labelFontSize: 14,
        lineColor: "#ddd",
	}],

	axisY:{
        title: "QPS",
		includeZero: true,
        titleFontSize: 14,
        labelFontSize: 14,
        tickPlacement: "inside", //Change it to "outside"
        labelPlacement: "inside", //Change it to "outside"
        gridColor: "#ddd"
	},

    width: 800,
	data: influxPlotData
})

function influxPlotUpdate() {
	count = 60;
	xVal = 0;
	yVal = 100;

	for (var j = 0; j < count; j++) {
		yVal = yVal +  Math.round(5 + Math.random() *(-5-5));
		influxPlotData[0].dataPoints.push({
			x: xVal,
			y: yVal
		});
		xVal++;
	}

	influxPlot.render();
};

//summaryPlotUpdate();
machPlotUpdate();
influxPlotUpdate();


</script>

</body>
</html>

