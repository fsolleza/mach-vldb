<html>
  <head>

    <style>
    a.canvasjs-chart-credit {
      visibility: hidden;
    }

    body {
      font-family: Arial !important;
      font-size: small;
    }

    .plotTitleOuter {
       height: 150px;
       width: 100px;
    }

    .plotTitleContainer {
       height: 150px;
       width: 100px;
       display: table-cell;
       vertical-align: middle;
    }

    .plotTitle {
       display: inner-block;
       float:right;
       writing-mode: sideways-lr;
       text-orientation: mixed;
       font-weight: bold;
       padding-right: 10px;
       font-size: medium;
    }

    .mainDiv {
      margin: auto;
      display: grid;
      grid-template-rows: auto;
      row-gap: 10px;
    }

    .columnDiv {
      margin: 0;
    }

  .headerRow {
  }

    .bodyRow {
      display: grid;
      grid-template-columns: 800px;
      column-gap: 10px;
  }

    span.boldSpan {
      font-weight: bold;
    }

  .charts {
    display: grid;
    grid-template-rows: auto auto;
    row-gap: 10px;
  }

    .chart {
    height: 250px;
    width: 800px;
    margin: 0px auto;
  }

  #storageTitle {
    font-size: xx-large;
    font-weight: bold;
  }


  </style>

  <title>
  </title>

  </head>
  <body>
    <div class="mainDiv">

      <div class="bodyRow">
        <div id="leftColumn" class="columnDiv">
          <p id="storageTitle"> Mach </p>

          <p style="font-size: large">
            Total Input Load (Records per Second):
            <span style="font-weight: bold" id="dataReceived">0</span>
          </p>

          <p style="font-size: large">
            Dropped Input Load (% of Total Input Load):
            <span style="font-weight: bold; color: #809f44" id="dataCompleteness">0</span>
          </p>

          <div class="charts">
            <div id="kvPercentileChart" class="chart"></div>
            <div id="syscallPercentileChart" class="chart"></div>
          </div>

        </div> <!-- leftColumn -->
      </div> <!-- bodyRow -->
    </div> <!-- mainDiv -->

  <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
  <script>
    /*
     * Parameters
     */
    var TILE = 0.999;
    var NOW = micros_now();
    var STORAGE = "Mach";
    var elem = document.getElementById("dataReceived");
    elem.innerText = STORAGE;

    /*
     * Update data received
     */
    function updateDataReceived() {
      var elem = document.getElementById("dataReceived");

      var req = {};
      req[STORAGE] = "DataReceived";

      var update_fn = function(data) {
        elem.innerText = data.DataReceived;
      };

      send_request(req, update_fn);
    }

    /*
     * Update data completeness
     */
    function updateCompleteness() {
      var elem = document.getElementById("dataCompleteness");

      var req = {};
      req[STORAGE] = "DataCompleteness";

      var update_fn = function(data) {
        //console.log(data);
        var c = 1 - data.DataCompleteness;
        elem.innerText = c * 100 + "%";
        if (c < 0.05) {
          elem.style.color = "#809f44";
        } else {
          elem.style.color = "#b25752";
        }
      };

      send_request(req, update_fn);
    }

    /*
     * Chart: KvOp Latency
     */
    var kvPercentileData = {
      type: "scatter",
      color: "#5a80b7",
      dataPoints: []
    };

    var kvPercentileDataFiller = {
      type: "scatter",
      color: "#5a80b7",
      dataPoints: []
    };

    var kvPercentileAxisX = {
      interval: 10,
      intervalType: "second",
      labelWrap: false,
      labelTextAlign: "right",
      labelAngle: -20,
      titleFontSize: 14,
      labelFontSize: 14,
      lineColor: "#ddd",
    };

    var kvPercentileAxisY = {
      title: "Latency (ms)",
      fontFamily: "arial",
      titleFontSize: 16,
    }

    function initChartXAxis(xMax, xAxis, data) {
      var xMin = xMax - 60;
      xAxis.minimum = secsToDt(xMin);
      xAxis.maximum = secsToDt(xMax);
      data.push({x: xAxis.minimum, y: null});
    }

    initChartXAxis(seconds_now() - 1, kvPercentileAxisX, kvPercentileData.dataPoints);

    var kvPercentileChartObject = {
      title: {
        text: "RocksDB KV Read Operation Latency in ms (>" + (TILE * 100) + "th \%ile)",
        fontFamily: "arial",
        fontSize: 16,
        fontWeight: "bold",
        backgroundColor: "#ffffff",
      },

      toolTip: { enabled: false, },

      axisX: [kvPercentileAxisX],
      axisY: [kvPercentileAxisY],

      data: [kvPercentileData],
    };

    var kvPercentileChart = new CanvasJS.Chart("kvPercentileChart", kvPercentileChartObject);

    function renderKvPercentileChart() {
        var enabled = ENABLED.kvops;

        var newData = [];

        if (enabled) {
          newData.push(kvPercentileData);
        } else {
          initChartXAxis(
            seconds_now() - 1,
            kvPercentileAxisX,
            kvPercentileDataFiller.dataPoints
          );
          newData.push(kvPercentileDataFiller);
        }

        kvPercentileChartObject.data = newData;
        kvPercentileChart.render();
    }


    function updateKvPercentileChart() {

      var now = micros_now();

      // set x axis range
      var xMax = now / 1000000 - 1;
      var xMin = xMax - 60;
      kvPercentileAxisX.minimum = secsToDt(xMin);
      kvPercentileAxisX.maximum = secsToDt(xMax);

      // setup new array for rendering
      var newPoints = [];
      var oldPoints = kvPercentileData.dataPoints;
      for (var i = 0; i < oldPoints.length; i++) {
        if (oldPoints[i].x > xMin) {
          newPoints.push(oldPoints[i]);
        }
      }
      kvPercentileData.dataPoints = newPoints;

      // setup request for the previous second of data
      var high = now - 1 * 1000000;
      var low = high - 1 * 1000000;
      var req = {};
      req[STORAGE] = {
            "KvOpsPercentile": {
              "low_ts": low, "high_ts": high, "tile": TILE
            }
        }

      var update_fn = function(data) {
        //console.log(data["KvOpsPercentile"][0]);

        var max_y = data.KvOpsPercentile.max_y;
        var roundup = roundUpY(max_y);
        console.log("kv max y", max_y, roundup);

        kvPercentileAxisY.minimum = 0;
        kvPercentileAxisY.maximum = roundup;
        kvPercentileAxisY.interval = roundup / 4;


        var l = data.KvOpsPercentile.data.length;

        for (var i = 0; i < l; i++) {
          var item = data.KvOpsPercentile.data[i].KVOp;
          var x = secsToDt(item.timestamp_micros / 1000000);
          kvPercentileData.dataPoints.push(
            { x: x, y: item.duration_micros }
          );
        }

        renderKvPercentileChart();
      };

      send_request(req, update_fn);
    }

    /*
     * Chart: Read system calls
     */

    var syscallPercentileData = {
      type: "scatter",
      showInLegend: true,
      color: "#a1ba65",
      legendText: "Read System Call Latency",
      dataPoints: []
    };

    var syscallPercentileDataFiller = {
      type: "scatter",
      color: "#a1ba65",
      dataPoints: []
    };

    var schedulerData = {
      type: "scatter",
      showInLegend: true,
      legendText: "Scheduler Event Occurrence",
      color: "#b15751",
      markerType: "square",
      markerSize: 10,
      dataPoints: []
    };

    var syscallPercentileAxisX = {
      interval: 10,
      intervalType: "second",
      labelWrap: false,
      labelTextAlign: "right",
      labelAngle: -20,
      labelFontSize: 14,
      lineColor: "#ddd",
    };

    var syscallPercentileAxisY = {
      title: "Latency (ms)",
      fontFamily: "arial",
      titleFontSize: 16,
    }
    var schedEventDataAxisY = {}

    var syscallPercentileChartObject = {
      title: {
        text: "Read System Call Latency in ms (>" + (TILE * 100) + "th \%ile)",
        fontFamily: "arial",
        fontSize: 16,
        fontWeight: "bold",
        backgroundColor: "#ffffff",
      },

      legend: {
        horizontalAlign: "center", // "center" , "right"
        verticalAlign: "bottom",  // "top" , "bottom"
        fontFamily: "arial",
        fontSize: 16,
      },

      toolTip: { enabled: false, },

      axisX: [syscallPercentileAxisX],
      axisY: [syscallPercentileAxisY],

      data: [syscallPercentileData, schedulerData],
    };

    initChartXAxis(seconds_now() - 1, syscallPercentileAxisX, syscallPercentileData.dataPoints);
    initChartXAxis(seconds_now() - 1, syscallPercentileAxisX, schedulerData.dataPoints);

    var syscallPercentileChart = new CanvasJS.Chart(
      "syscallPercentileChart",
      syscallPercentileChartObject
    );

    var ENABLED = {}
    window.onmessage = function(e) {
      ENABLED=e.data;
      console.log("In iframe child", ENABLED);
    };

    function renderSyscallPercentileChart() {
        var enableSyscall = ENABLED.syscalls;
        var enableScheduler = ENABLED.scheduler;

        var newData = [];

        if (enableSyscall) {
          newData.push(syscallPercentileData);
        } else {
          initChartXAxis(
            seconds_now() - 1,
            syscallPercentileAxisX,
            syscallPercentileDataFiller.dataPoints
          );
          newData.push(syscallPercentileDataFiller);
        }

        if (enableScheduler) {
          newData.push(schedulerData);
        }

        syscallPercentileChartObject.data = newData;
        syscallPercentileChart.render();
    }

    function updateReadSyscallsChart() {

      var now = micros_now();

      // set x axis range
      var xMax = now / 1000000 - 1;
      var xMin = xMax - 60;
      syscallPercentileAxisX.minimum = secsToDt(xMin);
      syscallPercentileAxisX.maximum = secsToDt(xMax);

      // setup new array for rendering
      var newPoints = [];
      var oldPoints = syscallPercentileData.dataPoints;
      for (var i = 0; i < oldPoints.length; i++) {
        if (oldPoints[i].x > xMin) {
          newPoints.push(oldPoints[i]);
        }
      }
      syscallPercentileData.dataPoints = newPoints;

      // setup request for the previous second of data
      var high = now - 1 * 1000000;
      var low = high - 1 * 1000000;
      var req = {};
      req[STORAGE] = {
            "ReadSyscalls": {
              "low_ts": low, "high_ts": high, "tile": TILE,
            }
        }

      var update_fn = function(data) {
        //console.log(data["ReadSyscalls"]);

        var max_y = data.ReadSyscalls.max_y;
        var roundup = roundUpY(max_y);

        console.log("duration max y", max_y, roundup);

        syscallPercentileAxisY.minimum = 0;
        syscallPercentileAxisY.maximum = roundup;
        syscallPercentileAxisY.interval = roundup / 4;

        var l = data.ReadSyscalls.data.length;
        for (var i = 0; i < l; i++) {
          var item = data.ReadSyscalls.data[i].Syscall;
          var x = secsToDt(item.timestamp_micros / 1000000);
          syscallPercentileData.dataPoints.push(
            { x: x, y: item.duration_micros }
          );
        }

        renderSyscallPercentileChart();
      };

      send_request(req, update_fn);
    }

    /*
     * Chart: Scheduler events
     */

    function updateSchedulerChart() {

      var now = micros_now();

      // set x axis range
      var xMax = now / 1000000 - 1;
      var xMin = xMax - 60;
      syscallPercentileAxisX.minimum = secsToDt(xMin);
      syscallPercentileAxisX.maximum = secsToDt(xMax);

      // setup new array for rendering
      var newPoints = [];
      var oldPoints = schedulerData.dataPoints;
      for (var i = 0; i < oldPoints.length; i++) {
        if (oldPoints[i].x > xMin) {
          newPoints.push(oldPoints[i]);
        }
      }
      schedulerData.dataPoints = newPoints;

      // setup request for the previous second of data
      var high = now - 1 * 1000000;
      var low = high - 1 * 1000000;
      var req = {};
      req[STORAGE] = {
            "Scheduler": {
              "low_ts": low, "high_ts": high
            }
        }

      var update_fn = function(data) {
        console.log(data["Scheduler"]);
        var l = data.Scheduler.length;
        for (var i = 0; i < l; i++) {
          var item = data.Scheduler[i].Scheduler;
          var x = secsToDt(item.timestamp_micros / 1000000);
          schedulerData.dataPoints.push(
            { x: x, y: 1 }
          );
        }

        // Adjust all y values for the scheduler events so that they show up in
        // the middle of the chart

        var yval = syscallPercentileAxisY.maximum / 2;
        var l = schedulerData.dataPoints.length;
        for (var i = 0; i < l; i++) {
          schedulerData.dataPoints[i].y = yval;
        }

        renderSyscallPercentileChart();
      };
      send_request(req, update_fn);
    }

    /*
     * Helper function to send request and call func when request completes
     */
    function send_request(req, func) {
      var request = JSON.stringify(req);
      var request = new Request("http://localhost:3000/dataRequest", {
        method: 'POST',
        body: request,
        headers: new Headers({
            'Content-Type': 'application/json'
        })
      });
      fetch(request)
        .then(data => data.json())
        .then(data => func(data));
    }

    /*
     * Helper functions to get microseconds now
     */
    function micros_now() {
      var nowSecs = seconds_now();
      return nowSecs * 1000000;
    }

    function seconds_now() {
      var nowSecs = Math.floor(Date.now() / 1000);
      return nowSecs;
    }

    /*
     * Helper to convert seconds since epoch to a Date object
     */
    function secsToDt(s) {
      var t = new Date(1970, 0, 1); // Epoch
      t.setSeconds(s);
      return t;
    }

    /*
     * Helper to convert duration in micros to nearest larger multiple of 10us,
     * 100us, 1000us, 10000us
     */
    function roundUpY(x) {
      if (x < 100) {
        return 100;
      }

      else if (x < 1000) {

        var remainder = x % 100;
        var increment = remainder - remainder % 10 + 20;
        return x - remainder + increment;
      }

      else if (x < 10000) {
        var remainder = x % 1000;
        var increment = remainder - remainder % 100 + 200;
        return x - remainder + increment;
      }

      else if (x < 100000) {
        var remainder = x % 10000;
        var increment = remainder - remainder % 1000 + 2000;
        return x - remainder + increment;
      }

      else if (x < 1000000) {
        var remainder = x % 100000;
        var increment = remainder - remainder % 10000 + 20000;
        return x - remainder + increment;
      }

      else {
        return x;
      }
    }

    /*
     * Update data and charts every second
     */
    syscallPercentileChart.render();
    kvPercentileChart.render();
    function updateData() {
      updateDataReceived();
      updateCompleteness();
      updateReadSyscallsChart();
      updateKvPercentileChart();
      updateSchedulerChart();
    }
    setInterval(updateData, 1000);

  </script>
  </body>
</html>

